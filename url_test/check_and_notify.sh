#!/bin/bash

set -euo pipefail

# ====================================================================================
#
#          FILE:  check_and_notify.sh
#
#         USAGE:  (–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ cron)
#
#   DESCRIPTION:  –ü—Ä–æ–≤–µ—Ä—è–µ—Ç VLESS-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–æ –≥–æ—Ç–æ–≤—ã–º –∫–æ–Ω—Ñ–∏–≥–∞–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç
#                 —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram –≤ —Å–ª—É—á–∞–µ —Å–±–æ—è.
#
#  REQUIREMENTS:  xray, curl
#
# ====================================================================================

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---

# –¢–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ Telegram-–±–æ—Ç–∞ (–ø–æ–ª—É—á–µ–Ω–Ω—ã–π –æ—Ç @BotFather)
TELEGRAM_BOT_TOKEN=""

# ID –≤–∞—à–µ–≥–æ —á–∞—Ç–∞ –∏–ª–∏ –∫–∞–Ω–∞–ª–∞ (–ø–æ–ª—É—á–µ–Ω–Ω—ã–π –æ—Ç @userinfobot)
TELEGRAM_CHAT_ID=""

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è, –≥–¥–µ –ª–µ–∂–∞—Ç –≥–æ—Ç–æ–≤—ã–µ .json —Ñ–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π.
CONFIG_DIR="/root/xray/vless_configs"

# URL –¥–ª—è —Ç–µ—Å—Ç–∞ –∏ —Ç–∞–π–º–∞—É—Ç.
TEST_URL="https://www.gstatic.com/generate_204"
CURL_TIMEOUT=15

# –ü—É—Ç—å –∫ Xray.
XRAY_PATH="/usr/local/bin/xray"

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è (—á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏).
STATE_DIR="/tmp/vless_monitor_states"

# --- –§–£–ù–ö–¶–ò–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ---
send_telegram_notification() {
    local message="$1"
    # URL-–∫–æ–¥–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏
    local encoded_message=$(printf %s "$message" | jq -s -R -r @uri)
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º curl –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ Telegram Bot API
    curl -s -o /dev/null "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage?chat_id=$TELEGRAM_CHAT_ID&text=$encoded_message"
}

# --- –û–°–ù–û–í–ù–û–ô –°–ö–†–ò–ü–¢ ---

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ñ–∞–π–ª–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è, –µ—Å–ª–∏ –µ–µ –Ω–µ—Ç
mkdir -p "$STATE_DIR"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É—é—Ç –ª–∏ –≤–æ–æ–±—â–µ —Ñ–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
if ! ls "$CONFIG_DIR"/*.json &> /dev/null; then
    echo "–û—à–∏–±–∫–∞: –í –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ $CONFIG_DIR –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —Ñ–∞–π–ª—ã .json"
    exit 1
fi

# –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ .json —Ñ–∞–π–ª—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
for config_file in "$CONFIG_DIR"/*.json; do

   # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï ---
    # –ò–∑–≤–ª–µ–∫–∞–µ–º "–∫—Ä–∞—Å–∏–≤–æ–µ" –∏–º—è –∏–∑ —Å–∞–º–æ–≥–æ JSON-—Ñ–∞–π–ª–∞ —Å –ø–æ–º–æ—â—å—é jq
    display_name=$(jq -r '.MyComment.displayName' "$config_file")
    
    # –ï—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –∏–º—è –Ω–µ –Ω–∞—à–ª–æ—Å—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –¥–ª—è –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏
    if [[ -z "$display_name" ]]; then
        display_name=$(basename "$config_file" .json)
    fi
 
    # –ü–æ–ª—É—á–∞–µ–º —á–∏—Å—Ç–æ–µ –∏–º—è —Å–µ—Ä–≤–µ—Ä–∞ –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
    state_file="$STATE_DIR/$(basename "$config_file" .json).down"

    # –ó–∞–ø—É—Å–∫–∞–µ–º Xray –≤ —Ñ–æ–Ω–µ
    $XRAY_PATH -config "$config_file" &> /dev/null &
    XRAY_PID=$!
    sleep 2

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –ª–∏ Xray
    if ! kill -0 $XRAY_PID 2>/dev/null; then
        if [ ! -f "$state_file" ]; then
            send_telegram_notification "üö® –¢—Ä–µ–≤–æ–≥–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å Xray –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞ '$display_name'. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é!"
            touch "$state_file" # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å–æ—Å—Ç–æ—è–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ —Å–ª–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ
        fi
        continue # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∫–æ–Ω—Ñ–∏–≥—É
    fi

    # –í—ã–ø–æ–ª–Ω—è–µ–º —Ç–µ—Å—Ç
    curl -s --proxy "socks5h://127.0.0.1:10808" -m $CURL_TIMEOUT "$TEST_URL" &> /dev/null
    CURL_EXIT_CODE=$?

    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Xray
    kill $XRAY_PID
    wait $XRAY_PID 2>/dev/null

    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    if [ $CURL_EXIT_CODE -ne 0 ]; then
        # –ü–†–û–í–ê–õ. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –ª–∏ —É–∂–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.
        if [ ! -f "$state_file" ]; then
            # –§–∞–π–ª–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–µ—Ç, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –ø–µ—Ä–≤–∞—è –æ—à–∏–±–∫–∞. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.
            send_telegram_notification "üî¥ –°–ë–û–ô: VLESS-—Å–µ—Ä–≤–µ—Ä '$display_name' –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω! –ö–æ–¥ –æ—à–∏–±–∫–∏ curl: $CURL_EXIT_CODE."
            touch "$state_file" # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª, —á—Ç–æ–±—ã –æ—Ç–º–µ—Ç–∏—Ç—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä —É–ø–∞–ª
        fi
    else
        send_telegram_notification "‚úîÔ∏è –¢–ï–°–¢: –°–µ—Ä–≤–µ—Ä '$display_name' —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω."
        # –£–°–ü–ï–•. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ —Å–µ—Ä–≤–µ—Ä —Ä–∞–Ω–µ–µ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.
        if [ -f "$state_file" ]; then
            # –§–∞–π–ª —Å–æ—Å—Ç–æ—è–Ω–∏—è –µ—Å—Ç—å, –∑–Ω–∞—á–∏—Ç —Å–µ—Ä–≤–µ—Ä "–ø–æ–¥–Ω—è–ª—Å—è".
            send_telegram_notification "‚úÖ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï: VLESS-—Å–µ—Ä–≤–µ—Ä '$display_name' —Å–Ω–æ–≤–∞ –≤ —Å—Ç—Ä–æ—é!"
            rm "$state_file" # –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª —Å–æ—Å—Ç–æ—è–Ω–∏—è
        fi
    fi
done
