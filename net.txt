# ===================================================================
# Оптимизированные параметры ядра для VLESS REALITY VPN-сервера
# Целевая система: 1 CPU, 2GB RAM, 20 пользователей, Ubuntu 24.04
# ===================================================================

# --- Управление Ресурсами и Памятью ---

# Системный лимит на количество открытых файловых дескрипторов.
# Значение 524288 является достаточным для 20 пользователей и их соединений.
fs.file-max = 524288

# Стратегия использования свопа. Значение 10 (вместо 60 по умолчанию)
# заставляет ядро предпочитать сброс файлового кэша вместо выгрузки
# памяти приложений в своп. Критично для производительности VPN-сервера.
vm.swappiness = 10

# --- Сетевые Буферы (Консервативные значения для 2GB RAM) ---

# Максимальный размер буфера на чтение/запись для любого сокета.
# Ограничено 4МБ для предотвращения исчерпания памяти на VPS с 2GB RAM.
net.core.rmem_max = 4194304
net.core.wmem_max = 4194304

# Параметры автотюнинга TCP-буферов (min, default, max).
# Максимальное значение ограничено 4МБ в соответствии с net.core.*mem_max.
net.ipv4.tcp_rmem = 4096 87380 4194304
net.ipv4.tcp_wmem = 4096 65536 4194304

# --- Управление Соединениями и Очередями ---

# Максимальный размер очереди полностью установленных соединений,
# ожидающих обработки приложением (accept queue).
net.core.somaxconn = 1024

# Максимальный размер очереди для пакетов, поступающих с сетевого
# адаптера, до их обработки ядром. Помогает при всплесках трафика.
net.core.netdev_max_backlog = 2048

# Максимальный размер очереди для соединений в состоянии SYN-RECEIVED.
# Увеличено для защиты от всплесков подключений и SYN-флуда.
net.ipv4.tcp_max_syn_backlog = 2048

# Максимальное количество сокетов в состоянии TIME_WAIT.
# Защищает от исчерпания ресурсов при высокой частоте переподключений.
net.ipv4.tcp_max_tw_buckets = 32768

# Время ожидания в состоянии FIN-WAIT-2. Уменьшено с 60 до 30 секунд
# для более быстрого освобождения ресурсов сокета.
net.ipv4.tcp_fin_timeout = 30

# --- Оптимизация Производительности TCP ---

# Включение алгоритма контроля перегрузки BBR от Google.
# Улучшает пропускную способность и снижает задержку на нестабильных сетях.
net.ipv4.tcp_congestion_control = bbr

# Установка планировщика пакетов Fair Queue (fq).
# Обязательное условие для корректной работы BBR, так как fq
# обеспечивает необходимый BBR механизм "пейсинга" (pacing).
net.core.default_qdisc = fq

# Включение TCP Fast Open (TFO). Значение 3 (1+2) включает TFO
# как для клиентских, так и для серверных соединений, уменьшая задержку
# при установке повторных TCP-сессий.
net.ipv4.tcp_fastopen = 3

# Настройки TCP Keepalive для своевременного обнаружения "мертвых" соединений.
# Время простоя перед первой пробой (300с = 5 мин).
net.ipv4.tcp_keepalive_time = 300
# Количество проб перед разрывом соединения.
net.ipv4.tcp_keepalive_probes = 5
# Интервал между пробами.
net.ipv4.tcp_keepalive_intvl = 15

# --- Параметры Безопасности (IPv4 и IPv6) ---

# Включение SYN-cookies для защиты от SYN-флуд атак.
net.ipv4.tcp_syncookies = 1

# Включение Reverse Path Filtering (rp_filter) в строгом режиме (1)
# для защиты от IP-спуфинга для IPv4 и IPv6.
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1
net.ipv6.conf.all.rp_filter = 1
net.ipv6.conf.default.rp_filter = 1

# Отключение приема пакетов с исходной маршрутизацией (source routing)
# для IPv4 и IPv6, так как это является вектором атаки.
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv6.conf.all.accept_source_route = 0
net.ipv6.conf.default.accept_source_route = 0

# --- Критически Важные Параметры для Функциональности IPv6 ---

# Глобальное включение пересылки (форвардинга) IPv6-пакетов.
# Необходимо, чтобы сервер мог маршрутизировать трафик для VPN-клиентов.
net.ipv6.conf.all.forwarding = 1

# Разрешение приема Router Advertisements (RA) даже при включенном форвардинге.
# Значение "2" предотвращает потерю сервером собственного IPv6-адреса и
# шлюза по умолчанию, которые он получает от провайдера через RA.
net.ipv6.conf.all.accept_ra = 2
net.ipv6.conf.default.accept_ra = 2

# Отключение TCP Timestamps для уменьшения уникальности отпечатка.
# Это приоритет для маскировки, несмотря на небольшое влияние на производительность.
net.ipv4.tcp_timestamps = 0

# Имитация TTL по умолчанию для Windows-систем (128) вместо Linux (64).
# Один из самых простых и эффективных методов маскировки ОС.
net.ipv4.ip_default_ttl = 128
